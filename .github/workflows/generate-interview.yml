# Generate Interview Implementation
#
# This workflow creates a GitHub Issue to track interview implementation generation.
# The issue contains all the configuration needed for generating the implementation.
#
# Generation Options:
# 1. LOCAL (Recommended): Clone repo, use an AI agent locally, push to interview branch
#    - Gives you full control over the output
#    - Interview guide stays private
#    - No reasoning visible in PRs
#
# 2. COPILOT: Manually assign the issue to copilot-swe-agent[bot]
#    - Copilot will create a PR automatically
#    - Note: PR description will contain visible reasoning
#    - Interview guide must be generated separately
#
# See .specify/WORKFLOW.md for complete instructions.

name: Generate Interview Implementation

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'Programming language and framework'
        required: true
        type: choice
        options:
          - python-fastapi
          - nodejs-express
          - csharp-dotnet
          - java-springboot
          - go-gin
          - ruby-rails
          - typescript-nestjs
      role:
        description: 'Interview role'
        required: true
        type: choice
        options:
          - backend
          - fullstack
          - devops
          - security
          - accessibility
      level:
        description: 'Candidate experience level'
        required: true
        type: choice
        options:
          - junior
          - mid
          - senior
          - staff

permissions:
  contents: write
  issues: write

jobs:
  create-implementation-issue:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
      issue_url: ${{ steps.create-issue.outputs.issue_url }}
      branch_name: ${{ steps.set-vars.outputs.branch_name }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set variables
        id: set-vars
        run: |
          BRANCH_NAME="interview/${{ inputs.language }}-${{ inputs.role }}-${{ inputs.level }}"
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "Branch name: ${BRANCH_NAME}"

      - name: Check if branch already exists
        id: check-branch
        run: |
          if git ls-remote --heads origin "${{ steps.set-vars.outputs.branch_name }}" | grep -q .; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
            echo "::warning::Branch ${{ steps.set-vars.outputs.branch_name }} already exists. Implementation will be regenerated."
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create implementation issue
        id: create-issue
        env:
          LANGUAGE: ${{ inputs.language }}
          ROLE: ${{ inputs.role }}
          LEVEL: ${{ inputs.level }}
          BRANCH_NAME: ${{ steps.set-vars.outputs.branch_name }}
          BRANCH_EXISTS: ${{ steps.check-branch.outputs.branch_exists }}
          REPO: ${{ github.repository }}
        uses: actions/github-script@v7
        with:
          script: |
            const language = process.env.LANGUAGE;
            const role = process.env.ROLE;
            const level = process.env.LEVEL;
            const branchName = process.env.BRANCH_NAME;
            const branchExists = process.env.BRANCH_EXISTS === 'true';
            const repo = process.env.REPO;
            
            // Map inputs to human-readable format
            const languageMap = {
              'python-fastapi': 'Python with FastAPI',
              'nodejs-express': 'Node.js with Express',
              'csharp-dotnet': '.NET/C# with ASP.NET Core',
              'java-springboot': 'Java with Spring Boot',
              'go-gin': 'Go with Gin',
              'ruby-rails': 'Ruby on Rails',
              'typescript-nestjs': 'TypeScript with NestJS'
            };
            
            const roleMap = {
              'backend': 'Backend Engineer',
              'fullstack': 'Full Stack Engineer',
              'devops': 'DevOps/SRE Engineer',
              'security': 'Security Engineer',
              'accessibility': 'Accessibility Specialist'
            };
            
            const levelMap = {
              'junior': 'Junior (0-2 years)',
              'mid': 'Mid-level (2-5 years)',
              'senior': 'Senior (5-8 years)',
              'staff': 'Staff/Principal (8+ years)'
            };
            
            const humanLanguage = languageMap[language] || language;
            const humanRole = roleMap[role] || role;
            const humanLevel = levelMap[level] || level;
            
            const branchNote = branchExists ? '\n> **Note:** This branch already exists and will be regenerated.\n' : '';
            
            // Create issue body - using array join to avoid YAML escaping issues
            const issueBody = [
              '## Interview Implementation Request',
              '',
              '**Target Branch:** `' + branchName + '`',
              '**Language/Framework:** ' + humanLanguage,
              '**Role:** ' + humanRole,
              '**Level:** ' + humanLevel,
              branchNote,
              '---',
              '',
              '## How to Generate',
              '',
              '### Option 1: Local Generation (Recommended)',
              '',
              'Generate locally using an AI coding agent for full control:',
              '',
              '```bash',
              '# Clone and create branch',
              'git clone https://github.com/' + repo + '.git',
              'cd pie-shop',
              'git checkout -b ' + branchName,
              '',
              '# Use the implementation prompt with your AI agent',
              '# Copy .specify/IMPLEMENTATION_PROMPT.md and provide these answers:',
              '# 1. Language: ' + humanLanguage,
              '# 2. Role: ' + humanRole,
              '# 3. Level: ' + humanLevel,
              '',
              '# After generation, commit and push',
              'git add .',
              'git commit -m "Add ' + humanLanguage + ' implementation for ' + humanRole + ' (' + level + ')"',
              'git push -u origin ' + branchName,
              '```',
              '',
              '**Benefits:**',
              '- Interview guide generated privately (save to shared drive)',
              '- Full control over what gets committed',
              '- No reasoning/discussion visible to candidates',
              '',
              '### Option 2: GitHub Copilot',
              '',
              'Assign this issue to `copilot-swe-agent[bot]` to have Copilot generate the implementation.',
              '',
              '**Note:** Copilot\'s PR will contain visible reasoning in the description. You\'ll need to:',
              '1. Review and clean up the PR description before sharing with candidates',
              '2. Generate the interview guide separately',
              '',
              '---',
              '',
              '## Implementation Requirements',
              '',
              'Read and follow the complete implementation guide in `.specify/IMPLEMENTATION_PROMPT.md`.',
              '',
              'Key requirements:',
              '- Generate production-like code with **intentional technical debt**',
              '- Create working Docker Compose setup',
              '- Include mock services for external dependencies',
              '- Generate UI with accessibility issues',
              '- Create tests with mixed quality (some good, some gaps)',
              '',
              '### CRITICAL: No Interview Hints',
              '',
              '**DO NOT add comments that telegraph issues to candidates.**',
              '',
              'Bad (interview hints):',
              '- `// SECURITY ISSUE: No authentication`',
              '- `// This should be exponential backoff!`',
              '- `// ACCESSIBILITY: Missing labels`',
              '',
              'Good (natural TODOs):',
              '- `// TODO: Add authentication middleware`',
              '- `// Basic retry logic`',
              '- No comment at all (let code speak for itself)',
              '',
              'See `AGENTS.md` and `.specify/IMPLEMENTATION_PROMPT.md` for complete guidelines.',
              '',
              '---',
              '',
              '## Reference Documents',
              '',
              '- `.specify/features/001-pie-shop-orchestration.md` - Feature specification',
              '- `.specify/memory/constitution.md` - Project principles',
              '- `.specify/IMPLEMENTATION_PROMPT.md` - Detailed implementation guide',
              '- `AGENTS.md` - LLM guidelines',
              '',
              '---',
              '',
              '## Acceptance Criteria',
              '',
              '- [ ] All code compiles/runs without errors',
              '- [ ] Docker Compose starts all services',
              '- [ ] State machine tests pass',
              '- [ ] Integration test for happy path passes',
              '- [ ] UI renders order form and admin dashboard',
              '- [ ] No interview hints in comments',
              '- [ ] Interview guide saved to shared drive (if generated)',
            ].join('\n');

            // Create the issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Generate ' + humanLanguage + ' implementation for ' + humanRole + ' (' + level + ')',
              body: issueBody,
              labels: ['interview-generation', language, role, level]
            });

            console.log('Created issue #' + issue.data.number + ': ' + issue.data.html_url);
            
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Interview Implementation Issue Created

          **Issue:** #${{ steps.create-issue.outputs.issue_number }}
          **URL:** ${{ steps.create-issue.outputs.issue_url }}

          ### Configuration
          - **Language:** ${{ inputs.language }}
          - **Role:** ${{ inputs.role }}
          - **Level:** ${{ inputs.level }}
          - **Target Branch:** `${{ steps.set-vars.outputs.branch_name }}`

          ### Next Steps

          **Option 1 - Local Generation (Recommended):**
          1. Clone the repo and create branch `${{ steps.set-vars.outputs.branch_name }}`
          2. Use `.specify/IMPLEMENTATION_PROMPT.md` with an AI agent
          3. Save interview guide to shared drive
          4. Commit implementation and push

          **Option 2 - GitHub Copilot:**
          1. Assign the issue to `copilot-swe-agent[bot]`
          2. Review PR and clean up description
          3. Generate interview guide separately
          EOF
